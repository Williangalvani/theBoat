
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Boat!</title>

    <!-- Bootstrap core CSS -->
    <link href="/dist/bootstrap.min.css" rel="stylesheet">
     <link href="/dist/custom.css" rel="stylesheet">      

    <!-- Custom styles for this template 
    <link href="navbar-static-top.css" rel="stylesheet">    -->

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="../../assets/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <!-- Static navbar -->
    <nav class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Project name</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="#contact">Contact</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Waypoints <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu" id="waypointul">
                <!--<li><a href="#">Action</a></li>
                <li class="divider"></li>
                <li class="dropdown-header">Nav header</li>
                <li><a href="#">Separated link</a></li>
                <li><a href="#">One more separated link</a></li>-->
              </ul>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a href="../navbar/">Default</a></li>
            <li class="active"><a href="./">Static top <span class="sr-only">(current)</span></a></li>
            <li><a href="../navbar-fixed-top/">Fixed top</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>


    <div class="container" style="margin-left: 0px; padding-left: 0px;">

      <!-- Main component for a primary marketing message padding-lef or call to action -->
<div style="position: absolute;
       top: 50px; /* Header Height */
       bottom: 0px; /* Footer Height */
       width: 100%;">
    <div id="map" style="width: 100%; height:100%; float:left;"></div>
    <script src="../dist/jquery-1.11.3.min.js"></script>    
    <script src="../dist/leaflet.js"></script>
    <script>
var waypoints = null;

$(document).ready(function() {


    var map = L.map('map').setView([62.79, 22.82], 18);
    L.tileLayer('/img/{z}/{x}-{y}.png', {
        maxZoom: 18,
    }).addTo(map);


    var marker = L.marker([62.79, 22.82]).addTo(map)
        .bindPopup("<span id='popup'><b>Hello world!</b><br />I am a popup.</span>").openPopup();


    var targetmarker = L.marker([62.79, 22.82], {
        draggable: 'true'
    })
    targetmarker.on('dragend', function(event) {
        var marker = event.target;
        var position = marker.getLatLng();
        //alert(position);
        marker.setLatLng(position, {
            draggable: 'true'
        }).bindPopup(position).update();
    });
    //      L.circle([51.508, -0.11], 500, {
    //          color: 'red',
    //          fillColor: '#f03',
    //          fillOpacity: 0.5
    //      }).addTo(map).bindPopup("I am a circle.");

    //      L.polygon([
    //          [51.509, -0.08],
    //          [51.503, -0.06],
    //          [51.51, -0.047]
    //      ]).addTo(map).bindPopup("I am a polygon.");

    var reloadwaypoints = function(waypointsa) {
        var arrayLength = waypointsa.length;
        var rawdata = "";
        for (var i = 0; i < arrayLength; i++) {
            rawdata = rawdata + "<li><a>Point" + i + "</a> <a class='glyphicon glyphicon-remove waypointdelete' href='#' id='w-" + i + "'></a></li>";
        };
        $("#waypointul").html(rawdata);
        $(".waypointdelete").click(function() {
            var id = $(this).attr("id").split('-')[1];

            $.getJSON("/delwaypoint/" + id, function(data) {

                reloadwaypoints(data);
                var latlngarray = reloadwaypointsonmap(data);
                waypoints.setLatLngs([latlngarray]);
                targetmarker.setLatLng(latlngarray[latlngarray.length-1]).addTo(map);
                targetmarker.update();
            });
        })



    };




    var popup = L.popup();



    var reloadwaypointsonmap = function(data) {
        var latlngarray = []
        var arrayLength = data.length;
        for (var i = 0; i < arrayLength; i++) {
            var pair = data[i];
            latlngarray.push(L.latLng(pair[0], pair[1]));
            console.log(pair);

        };
        if (!!!waypoints) {
            waypoints = L.multiPolyline(latlngarray).addTo(map);
        } else {
            waypoints.setLatLngs([latlngarray]);
        };
        return latlngarray;
    };

    function onMapClick(e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;
        $.getJSON("/newwaypoint/" + lat + "/" + lng, function(data) {
            var latlngarray = reloadwaypointsonmap(data);
            waypoints.setLatLngs([latlngarray]);
            reloadwaypoints(data);
            //alert( "Load was performed." );
        });
        targetmarker.setLatLng(e.latlng).addTo(map);
    }

    map.on('click', onMapClick);

    var posting = function() {
        var jqxhr = $.getJSON("/gps", function() {
                //console.log( "success" );
                //console.log(jqxhr.responseJSON);
                if (jqxhr.responseJSON[2]) {
                    marker.setLatLng(L.latLng(jqxhr.responseJSON[0], jqxhr.responseJSON[1]));
                    marker.update();
                    $("#popup").html("fix:" + jqxhr.responseJSON[2] + "<br>Lat:" + jqxhr.responseJSON[0] + "<br>Lon:" + jqxhr.responseJSON[1]);
                }

                //console.log(marker.getLatLng());
            })
            .done(function() {
                //console.log( "second success" );
            })
            .fail(function() {
                //console.log( "error" );
            })
            .always(function() {
                //console.log( "complete" );
            });
    }

    var t = setInterval(posting, 1000);
});
    </script>
</div>

    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="/dist/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script>
  </body>
</html>




<!DOCTYPE html>
<html>
<head>
	<title>Boat control</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="../dist/leaflet.css" />

</head>

</html>
